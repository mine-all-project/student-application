<!doctype html>
<html class="x-admin-sm"
>
<head>
	<div data-th-replace="/components/base :: javascript"></div>
	<div data-th-replace="/components/vue :: javascript"></div>
	<div data-th-replace="/components/ui :: antd"></div>
	<div data-th-replace="/components/base :: quill"></div>
	<style>
      .drawer-bottom-button {
          position: absolute;
          right: 0;
          bottom: 0;
          width: 100%;
          border-top: 1px solid #e9e9e9;
          padding: 10px 16px;
          background: #fff;
          text-align: right;
          z-index: 1;
      }
	</style>
</head>
<body>
<div id="app">
	<div><a-row>
		<a-col :span="6">
			<a-input placeholder="输入关键字搜索" v-model="form.searchText"></a-input>
		</a-col>
		<a-col :span="6" style="display: flex;justify-content: space-around">
			<a-button type="primary" @click="search">搜索</a-button>
			<a-button @click="resetList">重置</a-button>
		</a-col>
	</a-row>
		<a-divider></a-divider>
		<a-button type="default" @click="showAddPaper"> 添加文章</a-button>
		<a-divider></a-divider>
		<a-drawer width="50%" :visible="show.paper" @close="closePaperForm">
			<a-form-model :model="form.paper" :rules="rules" :label-col="labelCol" :wrapper-col="wrapperCol">
				<a-form-model-item label="标题" prop="title">
					<a-input v-model="form.paper.title" placeholder="请输入名称"></a-input>
				</a-form-model-item>
				<a-form-model-item label="图片" prop="image">
					<div class="clearfix">
						<a-upload name="file" list-type="picture-card" :file-list="temp.fileList" :headers="headers"
											action="/api/uploadFile" @preview="showPreview" @change="changeUploadFile"
											:remove="removeUploadFile">
							<div v-if="temp.fileList.length < 1">
								<a-icon type="plus"></a-icon>
								<div class="ant-upload-text"> 上传</div>
							</div>
						</a-upload>
					</div>
				</a-form-model-item>
				<a-form-model-item label="正文" prop="content">
					<a-textarea placeholder="正文" :rows="4" v-model="form.paper.content"></a-textarea>
				</a-form-model-item>
				<div v-if="false">
					<div v-if="editor.create">编辑器初始化中..</div>
					<div id="editor" style="height: 40vh"></div>
				</div>
			</a-form-model>
			<div class="drawer-bottom-button">
				<a-button :style="{ marginRight: '8px' }" @click="closePaperForm">关闭</a-button>
				<a-button type="primary" @click="savePaperForm">保存</a-button>
			</div>
		</a-drawer>
		<a-table :data-source="dataSource" rowKey="id" :columns="columns" :pagination="false">
			<span slot="type" slot-scope="text, record"> {{record.type_name}}</span>
			<span slot="content" slot-scope="text">
          <a-tooltip placement="topLeft">
            <template slot="title">
              <span>{{ text }}</span>
            </template>
            <span class="step-content">{{ text }}</span>
          </a-tooltip>
        </span>
			<span slot="action" slot-scope="text, record">
          <a-button type="primary" size="small" @click="showEditPaper(record)">编辑</a-button>
          <a-button type="danger" size="small" @click="removePaper(record)">删除</a-button>
			</span>
		</a-table>
		<a-modal :visible="show.previewImg" :footer="null" @cancel="closePreview">
			<img style="width: 100%" :src="temp.previewSrc"/>
		</a-modal>
	</div>
</div>
<script>
    const app = new Vue({
        el: '#app',
        data() {
            return {
                headers: headers,
                rules: {
                    title: [
                        {required: true, message: '请输入名称', trigger: 'blur'},
                    ],
                    content: [
                        {required: true, message: '请选择分类', trigger: 'blur'},
                    ],
                },
                columns: [
                    {
                        dataIndex: 'index',
                        key: 'index',
                        title: '序号',
                    },
                    {
                        dataIndex: 'title',
                        title: '标题',
                    },
                    {
                        dataIndex: 'content',
                        title: '内容',
                        scopedSlots: {customRender: 'content'},
                    },
                    {
                        title: '操作',
                        scopedSlots: {customRender: 'action'},
                    },
                ],
                dataSource: [],
                labelCol: {span: 5},
                wrapperCol: {span: 16},
                form: {
                    paper: {
                        id: '',
                        title: '',
                        content: '',
                    },
                    searchText: '',
                },
                show: {
                    paper: false,
                    previewImg: false,
                },
                temp: {
                    previewSrc: '',
                    isAddPaper: false,
                    fileList: []
                },
                editor: {
                    instance: null,
                    create: true,
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'], //加粗，斜体，下划线，删除线
                        ['blockquote', 'code-block'],  //引用，代码块
                        [{'list': 'ordered'}, {'list': 'bullet'}],  //列表
                        [{'color': []}, {'background': []}],  // 字体颜色，字体背景颜色
                        [{'align': []}], //对齐方式
                        ['clean'], //清除字体样式
                        ['image'] //上传图片、上传视频
                    ]
                },
                sysUser: sessionStorage.getItem("sysUser")
            };
        },
        mounted() {
            this.getList()
        },
        methods: {
            createEditor(content) {
                setTimeout(() => {
                    if (this.editor.create) {
                        this.editor.instance = new window.Quill('#editor', {
                            theme: 'snow',
                            modules: {
                                toolbar: this.editor.toolbar
                            }
                        })
                        this.editor.create = false
                    }
                    this.editor.instance.root.innerHTML = content
                }, 1000)
            },
            destroyEditor() {
                this.editor.instance.root.innerHTML = ''
            },
            refreshData() {
                this.getList()
            },
            getList() {
                axios.get('/api/paper/list').then(response => {
                    const result = response.data
                    if (result.status !== 200) {
                        this.$message.error(result.message);
                        return;
                    }
                    if (result.data !== null) {
                        this.formatList(result.data)
                    }
                }).catch(function (error) {
                    console.error('出现错误:', error);
                });
            },
            formatList(source) {
                this.dataSource = source.filter(e => {
                    return e.type === '1'
                }).map((e, index) => {
                    return {
                        index: index + 1,
                        id: e.id,
                        title: e.title,
                        content: e.content,
                        image: e.image,
                        type: e.type,
                        createTime: e.createTime,
                    }
                })
            },

            showAddPaper() {
                this.temp.fileList = []
                this.show.paper = true
            },
            showEditPaper(e) {
                console.log(e)
                this.temp.fileList = []
                this.show.paper = true
                this.form.paper.id = e.id
                this.form.paper.title = e.title
                this.form.paper.content = e.content
                if (e.image) {
                    this.temp.fileList.push({
                        uid: e.image.id,
                        name: e.image.oldName,
                        status: 'done',
                        url: e.image.virtualPath,

                        contentType: e.image.contentType,
                        createTime: e.image.createTime,
                        delFlag: e.image.delFlag,
                        fileSize: e.image.fileSize,
                        id: e.image.id,
                        oldName: e.image.oldName,
                        updateTime: e.image.updateTime,
                        uploadPath: e.image.uploadPath,
                        virtualPath: e.image.virtualPath,
                    })
                }

            },
            savePaperForm() {
                let data = this.form.paper
                data.image = this.temp.fileList[0]
                data.type = 1
                axios.post('/api/paper/save', data).then(response => {
                    const result = response.data
                    if (result.status !== 200) {
                        this.$message.error(result.message);
                        return;
                    }
                    this.closePaperForm()
                    this.refreshData()
                }).catch(function (error) {
                    console.error('出现错误:', error);
                });
            },
            closePaperForm() {
                this.form.paper = {
                    id: '',
                    name: '',
                }
                this.show.paper = false
            },
            removePaper(e) {
                const _this = this;
                this.$confirm({
                    title: '确认删除?',
                    cancelText: '取消',
                    okText: '确定',
                    onOk() {
                        axios.delete(`/api/paper/delete/${e.id}`).then(result => {
                            console.log('通过api获取到的数据:', result);
                            if (result.status !== 200) {
                                _this.$message.error(result.message);
                                return
                            }
                            _this.refreshData()
                            _this.$message.success(result.message)
                        }).catch(function (error) {
                            console.log('请求出现错误:', error);
                        });
                    },
                });
            },

            closePreview() {
                this.show.previewImg = false
            },
            async showPreview(file) {
                this.temp.previewSrc = file.url
                this.show.previewImg = true
            },
            changeUploadFile(info) {
                if (info.file.status === 'uploading') {
                    this.temp.fileList = this.temp.fileList.filter(e => {
                        return e.uid !== info.file.uid
                    })
                    this.temp.fileList.push(info.file)
                } else if (info.file.status === 'done') {
                    this.temp.fileList.pop()
                    this.$message.success(`${info.file.name} 上传成功`);
                    this.temp.fileList.push({
                        uid: info.file.response.data.id,
                        name: info.file.response.data.oldName,
                        status: 'done',
                        url: info.file.response.data.virtualPath,

                        contentType: info.file.response.data.contentType,
                        createTime: info.file.response.data.createTime,
                        delFlag: info.file.response.data.delFlag,
                        fileSize: info.file.response.data.fileSize,
                        id: info.file.response.data.id,
                        oldName: info.file.response.data.oldName,
                        updateTime: info.file.response.data.updateTime,
                        uploadPath: info.file.response.data.uploadPath,
                        virtualPath: info.file.response.data.virtualPath,
                    })
                } else if (info.file.status === 'error') {
                    this.$message.error(`${info.file.name} 上传失败`);
                }
            },
            removeUploadFile(file) {
                this.temp.fileList = []
            },
        }
    })
</script>
</body>
</html>
