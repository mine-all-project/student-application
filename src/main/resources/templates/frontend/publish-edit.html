<html>
<head>
	<div data-th-replace="/components/base :: javascript"></div>
	<div data-th-replace="/components/base :: quill"></div>
	<div data-th-replace="/components/vue :: javascript"></div>
	<div data-th-replace="/components/ui :: antd"></div>
	<style>
      p {
          padding: 0;
          margin: 0
      }

      .content {
          display: flex;
          flex-direction: row;
          height: max-content
      }

      .menus {
          flex: 2;
          height: 100%;
          margin: 0;
          padding: 0;
      }

      .menus li {
          background-color: #999999;
          color: #505050;
          font-size: 14px;
          list-style: none;
          display: flex;
          align-items: center;
          justify-content: center;
          height: 85px;
          font-family: 'Microsoft YaHei';
      }

      .menus li:first-child {
          font-size: 14px;
          text-align: center;
          background-repeat: no-repeat;
          background-size: auto 100%;
          background-position: center;
          background-color: #47bcbc;
      }

      .ant-pagination-item-link {
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
      }

      .ql-snow .ql-stroke {
          stroke: rgba(153, 153, 153, 1) !important;

      }

      .ql-snow .ql-fill {
          fill: rgba(153, 153, 153, 1) !important;
      }

      .publish-button {
          text-align: center;
          width: 113px;
          height: 43px;
          font-size: 27px;
          background-color: #999999;
          color: #505050;
          position: absolute;
          top: 185px;
          right: 19px
      }

      .type {
          font-size: 14px;
          background-color: #999999;
          color: #505050;
          width: max-content;
          padding: 1rem 3rem;
          display: flex;
      }
	</style>
</head>
<body style="margin: 0;scroll: no; overflow-y: hidden">
<div style="" class="content" id="app">
	<ul class="menus">
		<li>编辑动态</li>
	</ul>
	<p onclick="window.history.back(-1)"><img src="/images/back.svg" style="width: 30px;">返回</p>
	<br>
	<div style="flex:10;height: 100%;padding: 2rem">
		<p class="type">
			<span>编辑动态</span>
		</p>
		<div style="height: 3px;background-color:#999999;margin-top: 10px;width: 889px"></div>
		<div
				style="
				width:866px;height:271px;margin-top: 10px;background-color:rgba(153, 153, 153, 0.11);padding: 8px 27px 90px 9px;position: relative">
			<!--			<a-upload  name="file" action="/api/uploadFile"-->
			<!--								:multiple="true" :file-list="temp.imageList" :remove="removeUploadImage"-->
			<!--								@preview="showPreview" @change="changeUploadImage" :show-upload-list="false">-->
			<!--				<div style="margin-left: 35px;">-->
			<!--					<a-icon type="camera" theme="filled" style="font-size: 40px;color:rgba(153, 153, 153, 1)"></a-icon>-->
			<!--				</div>-->
			<!--			</a-upload>-->
			<div id="editor" style="height: 173px;width:830px;background-color:#cccccc;"></div>
			<!-- Create toolbar container -->
			<div id="toolbar" style="border: none;display: flex;align-items: center;">
				<button class="ql-emoji" style="width: 50px;height: 50px;"></button>
				<a-upload class="ql-image" name="file" action="/api/uploadFile"
									:multiple="true" :file-list="temp.imageList" :remove="removeUploadImage"
									@preview="showPreview" @change="changeUploadImage" :show-upload-list="false">
					<div style="margin-left: 35px;">
						<a-icon type="camera" theme="filled" style="font-size: 40px;color:rgba(153, 153, 153, 1)"></a-icon>
					</div>
				</a-upload>
				<a-upload class="ql-file" name="file" action="/api/uploadFile"
									:multiple="true" :file-list="temp.fileList" :remove="removeUploadFile"
									@change="changeUploadFile" :show-upload-list="false">
					<div style="display: flex;flex-direction: column;align-items: center;color: #fff;margin-left: 35px;">
						<a-icon type="upload"></a-icon>
						<span>上传</span>
					</div>
				</a-upload>
			</div>
			<div class="publish-button" @click="publish">发布</div>
		</div>
		<a-upload name="file" action="/api/uploadFile" list-type="picture-card"
							:multiple="true" :file-list="temp.imageList" :remove="removeUploadImage"
							@preview="showPreview" @change="changeUploadImage" v-show="temp.imageList.length">
		</a-upload>
		<a-upload name="file" action="/api/uploadFile"
							:multiple="true" :file-list="temp.fileList" :remove="removeUploadFile"
							@change="changeUploadFile">
		</a-upload>
		<a-modal :visible="show.previewImg" :footer="null" @cancel="closePreview">
			<img style="width: 100%" :src="temp.previewSrc"/>
		</a-modal>
	</div>
</div>
<script>
    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] == variable) {
                return pair[1];
            }
        }
        return (false);
    }

    const app = new Vue({
        el: '#app',
        components: {},
        data() {
            return {
                apiUrl: '',
                axios: axios,
                userInfo: {},
                isAdmin: false,
                isRoot: true,
                headers: headers,
                title: '校园资讯',
                secondTitle: '',
                titleKey: '',
                dataList: [],
                editor: {
                    instance: null,
                    create: true,
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'], //加粗，斜体，下划线，删除线
                        ['blockquote', 'code-block'],  //引用，代码块
                        [{'list': 'ordered'}, {'list': 'bullet'}],  //列表
                        [{'color': []}, {'background': []}],  // 字体颜色，字体背景颜色
                        [{'align': []}], //对齐方式
                        ['clean'], //清除字体样式
                        ['image'], //上传图片、上传视频
                        ['emoji'], //上传图片、上传视频
                    ]
                },
                show: {
                    previewImg: false,
                },
                temp: {
                    imageList: [],
                    fileList: [],
                    previewSrc: '',
                },
                tt: {
                    id: '',
                    type: '',
                    secondType: '',
                }
            }
        },
        mounted() {
            this.initType()
            this.getUserInfo('')
        },
        methods: {
            getUserInfo() {
                this.axios.get('/api/user/getUserInfo').then(response => {
                    const result = response.data
                    if (result.status !== 200) {
                        this.$message.error(result.message);
                        if (result.status === 401) {
                            window.location.href = '/frontend/login.html'
                        }
                        return;
                    }
                    if (result.data !== null) {
                        this.userInfo = result.data;
                        this.isAdmin = result.data.role === 0
                    }
                }).catch(function (error) {
                    console.error('出现错误:', error);
                });
            },
            publish() {
                let fileList = []
                this.temp.fileList.forEach(e => {
                    fileList.push(e.currentData)
                })
                this.temp.imageList.forEach(e => {
                    fileList.push(e.currentData)
                })
                let data = {
                    id: this.tt.id,
                    type: this.tt.type,
                    secondType: this.tt.secondType,
                    title: '',
                    messages: [],
                    content: this.editor.instance.root.innerHTML,
                    type: this.titleKey,
                    files: fileList,
                    secondType: this.secondTitle,
                }
                console.log(data)
                this.axios.post('/api/paper/save', data).then(response => {
                    const result = response.data
                    if (result.status !== 200) {
                        this.$message.error(result.message);
                        return;
                    }
                    alert("已发布，等待管理员审核")
                }).catch(function (error) {
                    console.error('出现错误:', error);
                });
            },
            /*upload*/
            changeUploadFile(info) {
                this.temp.fileList = info.fileList
                if (info.file.status === 'done') {
                    // this.$message.success(`${info.file.name} 上传成功`);
                    let data = {
                        id: info.file.response.data.id,
                        uid: info.file.response.data.id,
                        name: info.file.response.data.oldName,
                        status: 'done',
                        url: info.file.response.data.virtualPath,
                        currentData: info.file.response.data
                    }
                    info.currentData = info.file.response.data
                    this.temp.fileList.pop()
                    this.temp.fileList.push(data)
                } else if (info.file.status === 'error') {
                    this.$message.error(`${info.file.name} 上传失败`);
                }
            },
            removeUploadFile(file) {
                this.temp.fileList = this.temp.fileList.filter(e => {
                    return e.id !== file.id
                })
            },
            /*image*/
            changeUploadImage(info) {
                this.temp.imageList = info.fileList
                if (info.file.status === 'done') {
                    // this.$message.success(`${info.file.name} 上传成功`);
                    let data = {
                        id: info.file.response.data.id,
                        uid: info.file.response.data.id,
                        name: info.file.response.data.oldName,
                        status: 'done',
                        url: info.file.response.data.virtualPath,
                        currentData: info.file.response.data
                    }
                    info.currentData = info.file.response.data
                    this.temp.imageList.pop()
                    this.temp.imageList.push(data)
                } else if (info.file.status === 'error') {
                    this.$message.error(`${info.file.name} 上传失败`);
                }
            },
            removeUploadImage(file) {
                this.temp.imageList = this.temp.imageList.filter(e => {
                    return e.id !== file.id
                })
            },
            closePreview() {
                this.show.previewImg = false
            },
            async showPreview(file) {
                this.temp.previewSrc = file.url
                this.show.previewImg = true
            },

            createEditor(content) {
                setTimeout(() => {
                    if (this.editor.create) {
                        this.editor.instance = new window.Quill('#editor', {
                            theme: 'snow',
                            modules: {
                                // toolbar: this.editor.toolbar,
                                toolbar: '#toolbar',
                                "emoji-toolbar": true,
                                // "emoji-shortname": true,
                                // "emoji-textarea": true,
                                // handlers: {
                                //     // 'image': customFormulaHandler
                                // }
                            }
                        })
                        this.editor.create = false
                    }
                    this.editor.instance.root.innerHTML = content
                }, 1000)
            },
            destroyEditor() {
                this.editor.instance.root.innerHTML = ''
            },
            findById(id) {
                this.axios.get(`/api/paper/id?id=${id}`).then(response => {
                    const result = response.data
                    if (result.status !== 200) {
                        this.$message.error(result.message);
                        return;
                    }
                    console.log(result.data.files)
                    let files = result.data.files.map(e => {
                        let data = {
                            id: e.id,
                            uid: e.id,
                            name: e.oldName,
                            status: 'done',
                            url: e.virtualPath,
                            contentType: e.contentType,
                            currentData: e
                        }
                        return data
                    })
                    let image = files.filter(r => {
                        return r.contentType.includes("image")
                    }).sort((a, b) => {
                        let createTimeA = new moment(a.createTime)
                        let createTimeB = new moment(b.createTime)
                        return createTimeA.diff(createTimeB, 's');
                    })
                    files = files.filter(r => {
                        return (!r.contentType.includes("image"))
                    }).sort((a, b) => {
                        let createTimeA = new moment(a.createTime)
                        let createTimeB = new moment(b.createTime)
                        return createTimeA.diff(createTimeB, 's');
                    })
                    this.temp.imageList = image
                    this.temp.fileList = files
                    this.tt.id = id
                    this.tt.type = result.data.type
                    this.tt.secondType = result.data.secondType
                    this.createEditor(result.data.content)
                }).catch(function (error) {
                    console.error('出现错误:', error);
                });
            },
            initType() {
                let key = getQueryVariable('key')
                let id = getQueryVariable('id')
                this.findById(id)
                switch (key) {
                    case 'news' :
                        this.title = '校园资讯';
                        break;
                    case 'trading' :
                        this.title = '二手交易';
                        break;
                    case 'employment' :
                        this.title = '就业速递';
                        break;
                    case 'lost-items' :
                        this.title = '失物招领';
                        break;
                    case 'question' :
                        this.title = '校园问答';
                        break;
                    case 'friends' :
                        this.title = '校园交友';
                        break;
                    case 'other' :
                        this.title = '其他';
                        break;
                    case 'car' :
                        this.title = '校园拼车';
                        break;
                }
                this.titleKey = key
            },
            changeSecondType(e) {
                this.isRoot = false
                this.secondTitle = e.name
            },
            changeOtherType(e) {
                console.log('changeOtherType-->', e)
            },
        }
    })
</script>
</body>
</html>
